---
title: "test"
author: "Nick McManus"
date: "2023-07-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)    ## always
library(here)         ## consistent file paths
library(stringr)      ## split up file names
library(lubridate)    ## mutate dates
library(terra)        ## better/faster GIS package
library(sf)           ## format plays nicer w/leaflet
library(raster)       ## format plays nicer w/leaflet
library(leaflet)      ## test interactive maps
```


## DATA WRANGLING

In this section, we'll crop and reproject spatial data as well as find zonal statistics and output dataframes useful for the Shiny.



### Zip codes

We want to find and save the zip codes located within the Central Valley portion of Kern county. This .shp will then be exported for use in the Shiny app.

*Note*: For the purposes of this app, the extent of zip codes will be cropped to only portions within both Kern county and the Central Valley. To keep the entire geometry of zips that are within Kern, see the commented out code chunk below. 
```{r}
## Read in data w/ 'sf' pkg (easier to filter by attribute).
## After filtering, make SpatVect obj (`terra` pkg)

kern <- st_read(here('data/counties_ca/cnty19_1.shp')) %>% 
  ## Only keep kern county
  dplyr::filter(COUNTY_NAM == "Kern") %>%
  dplyr::select(COUNTY_NAM) %>% 
  terra::vect() 

valley <- st_read(here('data/central_valley/Alluvial_Bnd.shp')) %>% 
  st_transform(crs = st_crs(kern)) %>% 
  vect() %>% 
  ## Only keep portion w/in Kern
  terra::intersect(kern)

zips <- st_read(here('data/zipcodes/CA_Zips.shp')) %>% 
  st_transform(crs = st_crs(kern)) %>% 
  ## only keep zipcodes
  dplyr::select(GEOID10) %>% 
  vect() %>% 
  terra::intersect(valley)


## ensure CRS is leaflet friendly
kern_zips <- terra::project(zips, "+proj=longlat +datum=WGS84")

## Save clipped zips
writeVector(kern_zips, here('data/zipcodes/kern_zips.shp'), overwrite = T)

## Save Kern and Valley vect for leaflet too
kern <- terra::project(kern, "+proj=longlat +datum=WGS84")
writeVector(kern, here('data/counties_ca/kern.shp'), overwrite = T)

valley <- terra::project(valley, "+proj=longlat +datum=WGS84")
writeVector(valley, here('data/central_valley/valley.shp'), overwrite = T)

```

```{r}
# ## Read in raw data
# zips <- st_read(here('data/zipcodes/CA_Zips.shp'))
# counties <- st_read(here('data/counties_ca/cnty19_1.shp')) 
# 
# ## make sure both layers have same crs
# zips_trans <- zips %>% 
#   st_transform(zips, crs = st_crs(counties)) %>%
#   ## only need to keep zipcode number
#   dplyr::select(GEOID10) 
# 
# ## Only keep name of counties
# counties <- dplyr::select(counties, COUNTY_NAM)
# 
# # kern <- dplyr::filter(counties, COUNTY_NAM == "Kern") 
# 
# 
# ## Keep zipcodes that touch Kern county
# kern_zips <- st_join(zips_trans, counties, join = st_intersects) %>% 
#   dplyr::filter(COUNTY_NAM == "Kern", 
#                 ## remove select zips that barely touch Kern
#                 !GEOID10 %in% c(93536, 93535, 93201, 
#                                 93239, 93204, 93453,
#                                 93257, 93260, 93219, 
#                                 93261, 93218)) 
#   
# ## Reproject zips to leaflet-required crs
# kern_zips_trans <- st_transform(kern_zips, crs = "+proj=longlat +datum=WGS84")
# 
# ## save
# st_write(kern_zips_trans, here("data/zipcodes/kern_zips.shp"))

```


### Standing water

Here we'll run zonal stats to determine how much standing water is present in each zip code. This information will be exported as a .csv and used for the Shiny app. To do this, we'll need to first ensure that our `kern_zips.shp` are the same crs as the water rasters. Then we'll use a function to loop through all the water rasters within the directory.
```{r}
## Create paths for water rasters and masks
path35 <- here('data/water/Landsat_Dan/p042r035//')
path36 <- here('data/water/Landsat_Dan/p042r036//')

## Extract dates for each based on LANDSAT naming convention
dates <- function(files) {
  str_split(files, "_", simplify = TRUE) %>% 
  as.data.frame() %>%
  mutate(date = lubridate::ymd(V4)) %>%
  dplyr::select(date)
}

## One df with all files and dates
waterInput_df <- data.frame("rast35" = list.files(path35, pattern="_T.TIF"),
                            "mask35" = list.files(path35, pattern = "QA_PIXEL.TIF"),
                            "rast36" = list.files(path36, pattern="_T.TIF"),
                            "mask36" = list.files(path36, pattern="QA_PIXEL.TIF")) %>%
  ## extract date from r35
  mutate(dates(rast35))


## Need same crs for zonal stats.
## Easier to transform vector than the high-res raster
r <- rast(paste0(path35, waterInput_df[1,1]))
kern_zips <- vect(here("data/zipcodes/kern_zips.shp")) %>%
  project(y = crs(r))


## Function to perform zonal stats and output results
waterStats <- function(rast35, mask35, rast36, mask36, zip_vect, dates) {
  
  ## raster and mask for row 35 -------------  
  r35 <- rast(paste0(path35, rast35))
  names(r35) <- "rast"
  m35 <- rast(paste0(path35, mask35))
  ## mask values of 1 are NA
  m35[m35 == 1] <- NA
  ## mask raster 35
  r_masked35 <- terra::mask(r35, m35)
 
  ## raster and mask for row 36 ---------------
  r36 <- rast(paste0(path36, rast36))
  names(r36) <- "rast"
  m36 <- rast(paste0(path36, mask36))
  ## mask values of 1 are NA
  m36[m36 == 1] <- NA
  ## mask raster 36
  r_masked36 <- terra::mask(r36, m36)
 
  ## merge rasts using SpatRastCollection
  s <- sprc(r_masked35, r_masked36)
  m <- merge(s)
 
  zonalStat <- terra::zonal(m, zip_vect, fun = 'sum', na.rm = TRUE)
  
  zonalStat_df <- zonalStat %>%
    ## assign values with corresponding zipcode
    mutate(zipcode = zip_vect$GEOID10, .before = 1) %>%
    ## convert values from # of pixels to acres
    ## w/30m resolution, each pixel is 900 m^2
    ## 4046.86 m^2 are in one acre
    rename(water_cells = "rast") %>%
    mutate(water_acres = water_cells * 900 / 4046.86) %>%
    ## finally, add date image was taken
    mutate(date = dates)

}

## Run fxn over list w/pmap
waterStats_df <- pmap_dfr(waterInput_df, waterStats, zip_vect = kern_zips, .progress = TRUE)

## export as .csv
write_csv(waterStats_df, here('data/water/water_acre_zipcode.csv'))
```



### Temperature

The mean daily temperature by zip code was extracted from the PRISM dataset using a Google Earth Engine script. This was exported as a CSV with variables for date ("imageID"), zip code ("GEOID10"), and daily mean temperate ("mean"). We'll simply read in a reformat the CSV to make the data easy for plotting in the Shiny.
```{r}
temp <- read_csv(here('data/temp/kern_tmean_GEE_output.csv'))

temp2 <- temp %>% 
  ## extract date from PRISM image id
  mutate(date = lubridate::ymd(imageID)) %>% 
  dplyr::select(!imageID) %>% 
  rename(tmean_c = mean) %>% 
  mutate(tmean_f = (tmean_c*(9/5))+32,
         .before = date)

write_csv(temp2, here('data/temp/kern_tmean_20180101_20230731.csv'))
```




### Trap data

Finally, we'll wrangle some trap data and aggregate it by zip code. Exact locations of traps should not be public, so instead we'll produce plots showing how the number of WNV positives found in traps across a zip code change by month/year.

Andy's new data:
```{r}
## Read in data
infect <- read_csv(here('data/traps/wnvMIRPIR1500LagWeeks0.csv')) %>% 
  janitor::clean_names()

## Select variables of interest
infect1 <- infect %>% 
  dplyr::select(clust, date, mir_all, mir_spline_all, pool_size, num_pools) %>% 
  rename(numPools_clust = num_pools)






### abundance
abund <- read_csv(here('data/traps/all1500LagWeeks0.csv'))
```



Old code:
```{r}
## Read in raw trap data
traps <- vect(here('data/wnv_cases/WNV_full_4_23_CA.shp'))

## Read in zips and set to same crs as traps
zips_kern <- vect(here("data/zipcodes/kern_zips.shp")) %>% 
  project(y = crs(traps))


## Find intersection using terra (much faster) then
## convert back to sf to save as a .csv
traps_kern <- terra::intersect(zips_kern, traps)
traps_kern_sf <- st_as_sf(traps_kern)

## Save intermediate .shp
# st_write(traps_kern_sf, here('data/wnv_cases/wnv_kern.shp'))
## Save csv
# write_csv(traps_kern_sf, here('data/wnv_cases/wnv_kern.csv'))
```


```{r}
## Now filter data and create test plots
cases_kern <- read_csv(here('data/wnv_cases/wnv_kern.csv')) %>% 
  janitor::clean_names()

cases_zip_yr <- cases_kern %>% 
  filter(geoid10 == 93203) %>% 
  group_by(year) %>% 
  summarize(cases = sum(count))


ggplot(data = cases_zip_yr, aes(x = year, y = cases))+
  geom_point(color = "sienna2", size = 3, alpha = 0.6) +
  geom_line(linewidth = 1, color = "sienna4") +
  labs(y = "Annual cases",
       x = element_blank()) +
  theme_classic() +
  theme(
    # axis.title.x = element_text(face = "bold", vjust = -1),
    axis.title.y = element_text(face = 'bold', vjust = 3)
  )

cases_zip_yr_mo <- cases_kern %>% 
    ## user input ex
  filter(geoid10 == 93252) %>% 
  filter(month == "Aug") %>% 
  group_by(year) %>% 
  summarize(cases = sum(count)) 

ggplot(data = cases_zip_yr_mo, aes(x = year, y = cases))+
  geom_point(color = "sienna2", size = 3, alpha = 0.6) +
  geom_line(linewidth = 1, color = "sienna4") +
  labs(y = "Cases by month",
       x = element_blank()) +
  theme_classic() +
  theme(
    # axis.title.x = element_text(face = "bold", vjust = -1),
    axis.title.y = element_text(face = 'bold', vjust = 3)
  )
```


### Transmission efficiency

Here we'll find an average WNV transmission efficiency for each zipcode.
*NOTE:* This may be replaced by R0 once the model is done.
```{r}
## Read in data
wnv_trans <- rast(here('data/Kern_transmission_raster_wgs84.tif'))

## easier to transform vector than high-res raster
kern_zips <- vect(here("data/zipcodes/kern_zips.shp")) %>% 
  project(y = crs(wnv_trans))

## find total average
trans_kern <- global(wnv_trans, "mean", na.rm = T)
trans_kern <- data.frame("trans_eff" = trans_kern[1,1], "zipcode" = "Kern")

## find the mean value per zip
trans_zonal <- terra::zonal(wnv_trans, kern_zips, fun = 'mean', na.rm = T)

trans_zonal_zips <- trans_zonal %>% 
  mutate(zipcode = kern_zips$GEOID10) %>% 
  rename(trans_eff = Kern_transmission_raster_wgs84) %>% 
  rbind(., trans_kern)

write_csv(trans_zonal_zips, here('data/transmission_efficiency_zipcodes.csv'))
```



## TEST PLOTS



Testing out water plot for shiny:
```{r}
### ANIMATION?
library(xts)

date<-seq(as.Date("2015-01-01"), as.Date("2015-01-10"), by="day")
a<-xts(1:10,order.by=date)
df = data.frame(Lat = rnorm(1)+10, Long = rnorm(1),Id=a)

data_a<-data.frame(a)
data_a1<-data_a %>%  
  mutate("Lat" =as.numeric(df[1,1]),"Long"=as.numeric(df[2,1]),"Date"=rownames(data_a))
```


```{r}
data <- read_csv(here('data/water/water_acre_zipcode.csv'))

user_input <- "93311"

data_filtered <- data %>% 
  filter(zipcode == user_input)


ggplot(data_filtered, aes(x = date, y = water_acres)) +
  geom_point(color = "dodgerblue3", size = 4, alpha = 0.6) +
  geom_line(size = 0.6, color = "dodgerblue4") +
  labs(y = "Surface water size (ha)",
       x = element_blank()) +
    ## customize axis with cont 'date' class data
  scale_x_date(limits = as.Date(c('2023-03-13', '2023-06-25')),
               date_breaks = "1 week",
               date_labels = "%b %d") +
  theme_classic() +
  theme(
    # axis.title.x = element_text(face = "bold", vjust = -1),
    axis.title.y = element_text(face = 'bold', vjust = 3)
  )
```






```{r}
water <- raster(here('data/water/time_series/LC09_CU_003011_20230625_20230701_02_DSWE_Binary2_T.tif'))
water_reproj <- projectRaster(water, crs = crs(trans_r), method = 'ngb')
names(water_reproj) <- "water_reproj"
water_reproj[water_reproj == 0] <- NA

writeRaster(water_reproj, here('data/water/water_reproj.tif'))
```


Testing leaflet outside of Shiny app

```{r}
wnv_trans <- raster(here('data/Kern_transmission_raster_wgs84.tif'))

pal <- colorNumeric(palette = 'viridis', domain = values(wnv_trans),
                    reverse = TRUE,
                    na.color = "transparent")


zips <- read_sf(here("data/zipcodes/kern_zips.shp"))

leaflet() %>% 
  ## Add background maps
  addTiles(group = "OpenStreetMaps") %>% 
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  ## Add rasters
  addRasterImage(wnv_trans, colors = pal, project = FALSE, group = "WNV Risk") %>%
  # addRasterImage(water_reproj, colors = 'dodgerblue4', project = FALSE, group = "Water") %>% 
  ## Add polygons
  addPolygons(data = zips, color = "#343434", 
              weight = 2, fillOpacity = 0.2,
              label = paste0("Zip code: ", zips$GEOID10),
              group = "Zip codes",
              highlightOptions = highlightOptions(weight = 5,
                                               color = "white",
                                               bringToFront = TRUE)) %>% 
  ## Add groups to map
  addLayersControl(
    baseGroups = c("OpenStreetMaps", "Toner Lite"),
    overlayGroups = c("WNV Risk", "Zip codes", "Water"),
    options = layersControlOptions(collapsed = T),
    position = "topleft"
  ) %>% 
  hideGroup("Zip codes") %>% 
  ## Add legend to map
  addLegend(pal = pal, values = values(wnv_trans),
            "bottomleft",
            title = "WNV Transmission Risk")%>% 
      setView(-119.3, 35.55, zoom = 11)

```

